<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" href="/styles/widgets.css">

  <script>
    /** @global retrieves env from localStorage (set by caller)
     *  @borrows API_SERVER
     *  @borrows ENTRIES_ENDPOINT
     */
    window.env = JSON.parse(localStorage.getItem('env'));

    let buffer;
  </script>
</head>

<body class="widget">
  <div id="textarea-container" class="content-container">
    <textarea id="texteditor" wrap="off"></textarea>
  </div>
  <form id="buttons" class="buttons-container">
    <input type="button" name="PUT" value="PUT">
    <input type="button" name="POST" value="POST">
    <br>
    <input type="button" name="clear" value="clear">
    <input type="button" name="revert" value="revert">
    <input type="button" name="save" value="save">
  </form>

  <script type="module">
    import idb from '/scripts/idb.js';

    const textareaContainer = document.getElementById('textarea-container');
    const texteditor = document.getElementById('texteditor');

    // pull buffered entry/update on storage
    window.onstorage = (event) => {
      if (event.key !== 'buffer') return;

      try {
        buffer = JSON.parse(event.newValue || {});
      } catch (err) {
        buffer = {};
      }

      texteditor.value = JSON.stringify(buffer, null, 2);
    };
    
    buttons.revert.onclick = () => {
      try {
        buffer = JSON.parse(localStorage.getItem('buffer'));
      } catch (err) {
        buffer = {};
      }

      texteditor.value = JSON.stringify(buffer, null, 2);
    }

    // push update to buffer
    const setBuffer = function () {
      try {
        buffer = JSON.parse(texteditor.value || {});
      } catch (err) {
        if (err instanceof SyntaxError) {
          alert('invalid JSON in textarea');
          return;
        }

        throw err;
      }

      localStorage.setItem('buffer', JSON.stringify(buffer));
    };

    buttons.save.onclick = setBuffer;

    window.addEventListener('keydown', event => {
      if (event.key === 'Enter' && event.ctrlKey) {
        buttons.save.dispatchEvent(new PointerEvent('click'));
      }
    });

    // button handlers
    buttons.clear.onclick = () => {
      texteditor.value = '';
    };

    buttons.POST.onclick = async () => {
      const endpoint = `${env.API_SERVER}${env.ENTRIES_ENDPOINT}`;

      try {
        buffer = JSON.parse(texteditor.value);
        localStorage.setItem('buffer', JSON.stringify(buffer));

        const res = await fetch(endpoint, {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify(buffer),
        });

        const statusMessage = `${res.status} ${res.statusText}`;
        if (res.status >= 400) throw new Error(statusMessage);

        await idb.app.add('entries', buffer);
      } catch (err) {
        alert(err);
      }
    };

    buttons.PUT.onclick = async () => {
      const endpoint = `${env.API_SERVER}${env.ENTRIES_ENDPOINT}/${buffer.id}`;

      try {
        buffer = JSON.parse(texteditor.value);
        localStorage.setItem('buffer', JSON.stringify(buffer));

        const res = await fetch(endpoint, {
          method: 'PUT',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify(buffer),
        });

        const statusMessage = `${res.status} ${res.statusText}`;
        if (res.status >= 400) throw new Error(statusMessage);

        await idb.app.put('entries', buffer);
      } catch (err) {
        alert(err);
      }
    };
  </script>
</body>

</html>