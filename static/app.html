<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" href="/styles/frames.css">
  <link rel="stylesheet" href="/styles/styles.css">

  <meta property="API_SERVER" value="/api">
  <meta property="ENTRIES_ENDPOINT" value="/entries">
  <meta property="JSON_DUMP_ENDPOINT" value="/entries/DUMP">
  <meta property="METADATA_ENDPOINT" value="/metadata">
  <meta property="ARCHIVE_ENDPOINT" value="/archives/generate">
  <meta property="BIBLATEX_ENDPOINT" value="/archives/generate-biblatex">

  <script>
    const setEnvFromMeta = function () {
      const properties = document.head.querySelectorAll('meta[property]');

      return [...properties].reduce((obj, elem) => ({
        ...obj,
        [elem.getAttribute('property')]: elem.getAttribute('value'),
      }), {});
    };

    window.env = setEnvFromMeta();
    localStorage.setItem('env', JSON.stringify(env));
  </script>

  <script type="module"> //indexedDB
    import idb from '/dev/idb.js';

    buttons['clear-DB'].onclick = () => idb.app.clear('entries');

    buttons['refresh-DB'].onclick = async () => {
      const endpoint = env.API_SERVER + env.JSON_DUMP_ENDPOINT;
      const res = await fetch(endpoint);
      const data = await res.json();

      const tx = idb.app.transaction('entries', 'readwrite');
      await Promise.all([
        tx.store.clear(),
        ...data.map((entry) => tx.store.put(entry)),
        tx.done,
      ]);
    };
  </script>
</head>

<body>
  <h1>welcome</h1>

  <div id="collection" class="widgets-container">
    <iframe id="selector" name="selector" src="/widgets/selector/selector.html"></iframe>
    <iframe id="visualeditor" name="visualeditor" src="/widgets/visualeditor/visualeditor.html"></iframe>
    <iframe id="texteditor" name="texteditor" src="/widgets/texteditor/texteditor.html"></iframe>

    <form id="buttons">
      <fieldset>
        <legend>control</legend>
        <input type="button" name="clear-storage" value="localStorage.clear()">
      </fieldset>

      <fieldset>
        <legend>indexedDB</legend>
        <legend style="text-align:center;">entries</legend>
        <input type="button" name="clear-DB" value="clear object store">
        <input type="button" name="refresh-DB" value="fetch from server">
      </fieldset>

      <fieldset>
        <legend>displays</legend>
        <input type="button" name="html-table" value="HTML table">
      </fieldset>

      <fieldset>
        <legend>downloads</legend>

        <input type="button" name="download-json" value="json">
        <input type="button" name="download-archive" value="archive">
        <input type="button" name="download-biblatex" value="BibLaTeX">
      </fieldset>
    </form>
  </div>
</body>

<script type="module">
  // button handlers
  import handlers from '/scripts/handlers.js';

  buttons['html-table'].addEventListener('click', () => {
    window.open('/views/table-view.html');
  });

  buttons['clear-storage'].addEventListener('click', () => localStorage.clear());

  buttons['download-archive'].addEventListener('click', async () => {
    const response = await fetch(env.API_SERVER + env.ARCHIVE_ENDPOINT);
    const filetype = response.headers.get('content-type');
    const blob = await response.blob();

    handlers.download({
      blob,
      basename: `db_${new Date().toISOString()}`,
      extname: '.tgz'
    });
  });

  buttons['download-json'].addEventListener('click', async () => {
    const response = await fetch(env.API_SERVER + env.JSON_DUMP_ENDPOINT);
    const filetype = response.headers.get('content-type');
    const blob = await response.blob();

    handlers.download({
      blob,
      basename: `db_${new Date().toISOString()}`,
      extname: '.json'
    });

  });

  buttons['download-biblatex'].addEventListener('click', async () => {
    const response = await fetch(env.API_SERVER + env.JSON_DUMP_ENDPOINT);
    const filetype = response.headers.get('content-type');
    const model = await response.json();

    // const { default: generateBib } = await import('/scripts/generate-biblatex.js');
    const blob = new Blob([handlers.generateBib(model)], { type: 'text/x-bibtex' });

    handlers.download({
      blob,
      basename: `db_${new Date().toISOString()}`,
      extname: '.bib'
    });
  });
</script>

</html>