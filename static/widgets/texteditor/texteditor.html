<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" href="/styles/widgets.css">

  <script>
    /** @global inherits env from caller
     *  @borrows API_SERVER
     *  @borrows ENTRIES_ENDPOINT
     */
    window.env = window.parent.env || window.opener.env;
  </script>
</head>

<body class="widget">
  <div id="textarea-container" class="content-container"></div>
  <form id="buttons" class="buttons-container">
    <input type="button" name="clear" value="clear">
    <input type="button" name="toVisualEditor" value="toVisualEditor">
    <input type="button" name="PUT" value="PUT">
    <input type="button" name="POST" value="POST">
  </form>

  <script type="module">
    import Widget from './TextEditorWidget.mjs';

    const collectionEndpoint = env.API_SERVER + env.ENTRIES_ENDPOINT;

    const textareaContainer = document.getElementById('textarea-container')
    const texteditor = new Widget(collectionEndpoint);

    texteditor.textarea.style.height = textareaContainer.clientHeight + 'px';
    textareaContainer.append(texteditor.textarea);

    // button handlers
    buttons.clear.addEventListener('click', () => texteditor.clear());
    buttons.POST.addEventListener('click', () => {
      texteditor.POST()
        .then(res => {
          if (res.status >= 400) throw new Error(`${res.status} ${res.statusText}`);

          window.parent.postMessage({ signal: 'refreshSelector' });
        })
        .catch(err => alert(err));
    })
    buttons.PUT.addEventListener('click', () => {
      texteditor.PUT()
        .then(res => {
          if (res.status >= 400) throw new Error(`${res.status} ${res.statusText}`);
        })
        .catch(err => alert(err));
    })
    buttons.toVisualEditor.addEventListener('click', () => {
      try {
        window.parent.postMessage({
          signal: 'toVisualEditor',
          message: JSON.parse(texteditor.textarea.value),
        });
      } catch (err) {
        if (err instanceof SyntaxError) alert(err);
        throw err;
      }
    });

    // message handler
    window.addEventListener('message', (event) => {
      switch (event.data.signal) {
        case 'display':
          texteditor.textarea.value = JSON.stringify(event.data.message, null, 2);
          break;
        case 'clear':
          texteditor.textarea.value = '';
          break;
        default:
          console.error(event.data)
      }
    });
  </script>
</body>

</html>